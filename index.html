<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Annotation Platform</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #e8f0fe; display: flex; flex-direction: column; align-items: center; }
    .container { display: flex; gap: 40px; width: 100%; max-width: 1200px; }
    .video-panel, .form-panel { flex: 1; background-color: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    video { width: 100%; max-width: 400px; border-radius: 10px; position: relative; z-index: 1; }
    .progress-markers {
      position: relative;
      width: 100%;
      height: 10px;
      background: transparent;
      margin-top: -12px;
      z-index: 2;
    }
    .marker {
      position: absolute;
      top: 0;
      width: 4px;
      height: 10px;
      background: #1a73e8;
      border-radius: 2px;
    }
    .expression-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
    .expression-grid button { font-size: 20px; padding: 8px; cursor: pointer; border: 2px solid transparent; border-radius: 5px; }
    .expression-grid button.selected { border: 2px solid #1a73e8; background-color: #d2e3fc; }
    .keywords { display: flex; flex-wrap: wrap; gap: 6px; }
    .keywords label { margin-right: 10px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; background-color: #ffffff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .btn-group { margin-top: 20px; display: flex; gap: 10px; }
    canvas { border: 1px solid #ccc; background-color: #ffffff; margin-top: 10px; cursor: crosshair; }
     
  </style>
</head>
<body>
  <h2 style="color: #1a73e8;">Video Annotation Platform</h2>
  <div class="container">
    <div class="video-panel">
      <label for="videoSelect">Video:</label>
      <select id="videoSelect">
        <option value="mina01.mp4">mina01.mp4</option>
        <option value="mina02.mp4">mina02.mp4</option>
        <option value="mina03.mp4">mina03.mp4</option>
        <option value="mina04.mp4">mina04.mp4</option>
        <option value="mina05.mp4">mina05.mp4</option>
      </select><br /><br />
      <div style="position: relative;">
        <video id="video" controls>
          <source src="mina01.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
        <div class="progress-markers" id="markerLayer"></div>
      </div>
    </div>

    <div class="form-panel">
      <h3 style="color: #1a73e8;">Add Annotation</h3>
      <div class="expression-grid" id="expressionGrid"></div><br /> 
    <label>ÊÉÖÁ∑íÁ∂≠Â∫¶ÔºàValence-ArousalÔºâÔºö</label><br /> 
    <canvas id="vaCanvas" width="200" height="200" style="margin-top: 4px;"></canvas>
    <div id="vaText" style="margin-top: 4px;">(0, 0)</div>
    <div style="font-size: 12px; color: gray; margin-top: 2px;">‚Äª X Ëª∏ÁÇ∫ ValenceÔºàÊ≠£Ë≤†ÊÉÖÊÑüÔºâÔºåY Ëª∏ÁÇ∫ ArousalÔºàÊøÄÁôºÁ®ãÂ∫¶Ôºâ</div>

    <br /> 
    <label>ÈóúÈçµÂ≠óÔºàKeywordsÔºâ:</label><br />
    <div class="keywords" id="keywords"></div><br /> 

      <label for="textDesc">Text description:</label><br />
      <textarea id="textDesc" rows="3" style="width: 100%;"></textarea><br /><br />

      <div class="btn-group">
        <button onclick="saveAnnotation()">Save</button>
        <button onclick="downloadAnnotations()">Download JSON</button>
      </div>
    </div>
  </div>

  <h3 style="color: #1a73e8;">Annotations</h3>
  <table>
    <thead>
      <tr><th>Time</th><th>Expression</th><th>Valence-Arousal</th><th>Keywords</th><th>Description</th><th>Action</th></tr>
    </thead>
    <tbody id="annotationTable"></tbody>
  </table>

<script>
const emotionCategories = {
  "üòÉ ÂñúÊÇÖ": ["ÊÑâÊÇÖ", "ÊîæÈ¨Ü", "ÊÑüÊüìÂäõ", "Á¨ëÂÆπ", "Âò¥ËßíËá™ÁÑ∂‰∏äÊèö", "ÁúºÁùõÂæÆÂΩéÈñÉ‰∫Æ", "ÁúâÊØõËá™ÁÑ∂ËàíÂ±ï", "ËáâÈ†∞Áï•ÂæÆ‰∏äÊèê"],
  "üò§ ÊåëÈáÅ": ["Ëá™ÊàëËÜ®ËÑπÊÑü", "ÁïåÁ∑öÊåëÊà∞", "ÊîØÈÖçÊÖæ", "Á∑äÁπÉÁöÑËá™‰ø°", "ÂñÆÈÇäÂò¥Ëßí‰∏äÊåë", "ÁúâÊØõÊåëËµ∑Â∏∂ÂÇ≤Ê∞£", "‰∏ÄÂÅ¥Âò¥ËßíÊåëËµ∑", "ÂáùË¶ñÂ∞çÊñπ", "ÁúâÊØõÂâçÂÇæÈõÜ‰∏≠", "ÁúºÁ•ûÂ∏∂ÊúâÂ£ìËø´ÊÑü"],
  "üò¢ ÊÜÇÈ¨±": ["Â£ìÊäë", "Â§±ËêΩ", "ÁõÆÂÖâ‰∏ãÂûÇ", "Âò¥ÂîáÁ∑äÈñâÁï•‰∏ãÂΩé", "ÁúºÁ•ûÊ®°Á≥ä‰∏çËÅöÁÑ¶", "ÁúâÊØõÂÖßÁ∏Æ"],
  "üò± È©öÊÅê": ["ÊÉÖÁ∑íÈÅéËºâ", "‰∏çÁ¢∫ÂÆöÊÑü", "Ë≠¶ÊàíÂèçÊáâ", "ÊÖåÂºµ", "ÁúºÁùõÁùúÂ§ß", "ÁúâÊØõÈ´òËÅ≥", "Âò¥Â∑¥ÂºµÈñãÂÅúÊªØ", "ËáâÈÉ®ËÇåËÇâÂÉµ‰Ωè"],
  "üòê ÊÄùËÄÉ": ["ÂÅúÈ†ì", "ÂÖßÂú®ËΩâÂåñ", "Ë™ûÂè•‰∏≠Ê≠¢", "ÁõÆÂÖâÊ∏∏Áßª", "Êá∏ÁΩÆÊÑü", "ÁúâÈ†≠ËºïÁö∫", "ÁúºÁ•ûÂæÄ‰∏äÊàñÂÅ¥ÊñπÊºÇÁßª", "Âò¥ËßíÁï•Êî∂", "ËáâÈÉ®ÁÑ°ÊòéÈ°ØË°®ÊÉÖ"],
  "üòé Ëá™‰ø°": ["ÂÖßÂú®ÂÆâÂÆö", "Ëá™ÊàëÁ¢∫ÂÆö", "Ê∞£Â†¥Âº∑ÁÉà", "Áõ¥Ë¶ñËßÄÁúæ", "ÊéåÊéßÊÑü", "ÁúºÁ•ûÂ†ÖÂÆö‰∏çÈñÉË∫≤", "Âò¥ËßíÂæÆÁøπ‰ΩÜÁ©©ÂÆö", "ËáâÈÉ®ËÇåËÇâÊúâÂºµÂäõ‰ΩÜ‰∏çÂÉµÁ°¨", "ÁúâÂûãÊ∏ÖÊô∞‰∏¶Â∞çÁ®±"],
  "ü§ó Ë¶™Âàá": ["ÂæÆÁ¨ë", "ÈñãÊîæ", "ËÅ≤Èü≥Ê∫´Êüî", "Êé•Á¥çÂßøÊÖã", "ÁúºÁ•û‰∫§ÊµÅ", "ÁúºÁùõÁï•ÂΩéÂëàÊúàÁâôÁãÄ", "Âò¥Â∑¥ÂëàÂåÖË¶ÜÂºèÂæÆÁ¨ë", "ËáâÈ†∞Ê∫´ÊüîÊîæÈ¨Ü", "ÁúâÂ∞æÁï•ÂæÆ‰∏äÊèö", "Êï¥È´îË°®ÊÉÖÊüîËªüÁÑ°ÊîªÊìäÊÄß"],
  "üòá Ê∫´Êüî": ["ÂëµË≠∑", "ÊÉÖÊÑüÊµÅÂãï", "ÊüîÂíåÂåÖË¶Ü", "Âê´ËìÑË°®ÈÅî", "Ê∫´Â∫¶ÊÑü", "ÁúºÁ•ûÊúâÂåÖÂÆπÊÑü", "ÂæÆÁ¨ë‰∏çË™áÂºµ‰ΩÜÁúüË™†", "ËáâÈÉ®ÈÇäÁ∑£Ëº™ÂªìÊîæÈ¨Ü", "Âò¥ÂûãÂúìÊΩ§‰∏çÂ∞ñÈä≥"],
  "üßê Êá∑Áñë": ["‰∏ç‰ø°‰ªªÊÑü", "ÁúâÈ†≠Áö∫Ëµ∑", "ÂÖßÈÉ®ÊäóÊãí", "Ëá™ÊàëË≥™Áñë", "‰∏ÄÈÇäÁúâÊØõ‰∏äÊåë", "ÁúºÁùõÂæÆÁûá", "Âò¥ËßíÁï•Êñú", "ËáâÈÉ®ÂëàÁèæÂØ©Ë¶ñÊÑü", "Âò¥ÂîáÁï•ÊúâÁ∑äÈñâ"],
  "üòî Â£ìÊäë": ["ÊÉÖÁ∑íÂ£ìÂà∂", "Â£ìÂäõÂÖßÊΩ∞", "ÈÅøÂÖçÁõÆÂÖâ", "Èö±Âøç", "Ë©±Ë™û‰øùÁïô", "ËáâÈÉ®Áï•Â∏∂Á∑äÁπÉ", "Âò¥ËßíÂæÆÂæÆ‰∏ãÂΩé", "ÁúâÊØõ‰∏ãÂ£ìËÅöÊîè", "ËáâÈÉ®ËÇåËÇâÂ£ì‰ΩèÂãï‰ΩúÂÇæÂêë"],
  "ü•≥ ÁãÇÂñú": ["ËÅ≤Èü≥È´òÊº≤", "Âãï‰ΩúÂ§ßÂπÖÂ∫¶", "ÁØÄÂ•èÂø´ÈÄü", "Ë™ûË®ÄË∑≥Ë∫ç", "ÁÑ°ÊãòÊùü", "Âò¥Â∑¥ÂºµÂ§ßÁîöËá≥Èú≤ÈΩíÁ¨ë", "ÁúºÁ•ûÂº∑ÁÉàÊîæÂÖâ", "ÁúâÊØõÈ´òËàâ", "ËáâÈ†∞ÊãâÈ´ò"],
  "üò° ÊÜ§ÊÄí": ["ÁúâÈ†≠Á∑äÈéñ", "Ë™ûÈÄüÂø´", "Ë™ûÊ∞£Âº∑ÁÉà", "ÊÉÖÁ∑íÁ∑äÁπÉ", "ÁúºÁ•ûÈä≥Âà©ÈõÜ‰∏≠", "Âò¥ÂîáÁ∑äÈñâÊàñÈ°´Êäñ", "ÈºªÁøºÊì¥Âºµ", "ÁúâÂøÉÁ∑äÂ£ì"],
  //"üò∂ Ê≤âÈªò": ["ÁÑ°Ë™û", "ÂºµÂäõÂÖßÈö±", "ÂÉµÁõ¥", "Ë°®ÊÉÖÁ©∫ÁôΩ", "ÂÅúÈ†ìÂª∂Èï∑", "ËáâÈÉ®Âπæ‰πéÊ≤íÊúâË°®ÊÉÖËÆäÂåñ", "ÁúºÁ•ûÂõ∫ÂÆö‰∏çÂãï", "Âò¥ËßíÁÑ°Ê≥¢Âãï", "ËáâÈÉ®ËÇåËÇâÂëà‰∏≠ÊÄßÈ¨ÜÂºõ", "Êï¥È´îË°®ÊÉÖÂ¶ÇË¢´ÂáçÁµê"]
};

const video = document.getElementById('video');
const videoSelect = document.getElementById('videoSelect');
const expressionGrid = document.getElementById('expressionGrid');
const keywordsDiv = document.getElementById('keywords');
const annotationTable = document.getElementById('annotationTable');
const vaCanvas = document.getElementById('vaCanvas');
const vaText = document.getElementById('vaText');
const markerLayer = document.getElementById('markerLayer');
const ctx = vaCanvas.getContext('2d');

let selectedExpression = null;
let annotations = [];
let vaCoord = { x: 0, y: 0 };
let editIndex = null;

Object.keys(emotionCategories).forEach(label => {
  const btn = document.createElement('button');
  btn.textContent = label;
  btn.onclick = () => {
    selectedExpression = { emoji: label.split(' ')[0], label: label.split(' ')[1] };
    document.querySelectorAll('.expression-grid button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    updateKeywordsForEmotion(label); // ÂãïÊÖãÊõ¥Êñ∞ÈóúÈçµÂ≠ó
  };
  expressionGrid.appendChild(btn);
});
videoSelect.onchange = () => {
  const file = videoSelect.value;
  video.src = file;
  annotations = [];
  annotationTable.innerHTML = '';
  markerLayer.innerHTML = '';
};
function saveAnnotation() {
  const time = parseFloat(video.currentTime.toFixed(2));
  const text = document.getElementById('textDesc').value;
  const checkedKeywords = [...keywordsDiv.querySelectorAll('input:checked')].map(c => c.value);
  if (!selectedExpression) return alert('Ë´ãÈÅ∏ÊìáË°®ÊÉÖ');

  const annotation = {
    video: videoSelect.value,
    time,
    expression: selectedExpression,
    valence_arousal: vaCoord,
    keywords: checkedKeywords,
    description: text
  };

  if (editIndex !== null) {
    annotations[editIndex] = annotation;
    editIndex = null;
    refreshTable();
  } else {
    annotations.push(annotation);
    addTableRow(annotation, annotations.length - 1);
    addMarker(time);
  }

  // ‚úÖ Ê∏ÖÈô§Á∑®ËºØÁãÄÊÖãËàáËº∏ÂÖ•Ê¨Ñ‰Ωç
  document.getElementById('textDesc').value = '';
  selectedExpression = null;
  vaCoord = { x: 0, y: 0 };
  drawCanvas();
  vaText.innerText = `(0, 0)`;

  document.querySelectorAll('.expression-grid button').forEach(b => b.classList.remove('selected'));
  [...keywordsDiv.querySelectorAll('input')].forEach(c => c.checked = false);
}
function refreshTable() {
  annotationTable.innerHTML = '';
  markerLayer.innerHTML = '';
  annotations.forEach((ann, i) => {
    addTableRow(ann, i);
    addMarker(ann.time);
  });
}
function addTableRow(ann, i) {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${ann.time}</td>
    <td>${ann.expression.emoji} ${ann.expression.label}</td>
    <td>(${ann.valence_arousal.x}, ${ann.valence_arousal.y})</td>
    <td>${ann.keywords.join(', ')}</td>
    <td>${ann.description}</td>
    <td>
      <button onclick="editAnnotation(${i})">‚úèÔ∏è</button>
      <button onclick="deleteAnnotation(${i})">üóë</button>
    </td>`;
  annotationTable.appendChild(row);
}
function editAnnotation(i) {
  const ann = annotations[i];
  editIndex = i;
  video.currentTime = ann.time;
  selectedExpression = ann.expression;
  document.getElementById('textDesc').value = ann.description;
  vaCoord = ann.valence_arousal;
  drawCanvas();
  vaText.innerText = `(${vaCoord.x}, ${vaCoord.y})`;

  // ‚úÖ ÈÇÑÂéüË°®ÊÉÖÈÅ∏Êìá
  document.querySelectorAll('.expression-grid button').forEach(b => {
    b.classList.toggle('selected', b.textContent.includes(ann.expression.label));
  });

  // ‚úÖ Êõ¥Êñ∞Á¥∞ÂàÜÈ°ûÈóúÈçµÂ≠ó
  const labelKey = `${ann.expression.emoji} ${ann.expression.label}`;
  updateKeywordsForEmotion(labelKey);

  // ‚úÖ ÂãæÈÅ∏Â∞çÊáâÈóúÈçµÂ≠ó
  [...keywordsDiv.querySelectorAll('input')].forEach(checkbox => {
    checkbox.checked = ann.keywords.includes(checkbox.value);
  });
}
function deleteAnnotation(i) {
  annotations.splice(i, 1);
  refreshTable();
}
function addMarker(time) {
  const marker = document.createElement('div');
  marker.classList.add('marker');
  const ratio = time / video.duration;
  marker.style.left = `${ratio * 100}%`;
  markerLayer.appendChild(marker);
}
function downloadAnnotations() {
  const blob = new Blob([JSON.stringify(annotations, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'annotations.json';
  a.click();
  URL.revokeObjectURL(url);
}
function drawCanvas() {
  ctx.clearRect(0, 0, vaCanvas.width, vaCanvas.height);

  // Áï´Âá∫‰∏≠ÂøÉÂçÅÂ≠óÁ∑ö
  ctx.strokeStyle = '#ccc';
  ctx.beginPath();
  ctx.moveTo(vaCanvas.width / 2, 0);
  ctx.lineTo(vaCanvas.width / 2, vaCanvas.height);
  ctx.moveTo(0, vaCanvas.height / 2);
  ctx.lineTo(vaCanvas.width, vaCanvas.height / 2);
  ctx.stroke();

  // Áï´Âá∫Èªû
  ctx.fillStyle = '#1a73e8';
  ctx.beginPath();
  ctx.arc(vaCoord.x * 100 + vaCanvas.width / 2, -vaCoord.y * 100 + vaCanvas.height / 2, 5, 0, 2 * Math.PI);
  ctx.fill();

  // Âä†‰∏äÊñáÂ≠óÊ®ôÁ±§
  ctx.fillStyle = 'black';
  ctx.font = '12px Arial';
  ctx.fillText('-1', 10, 20); // Â∑¶‰∏ä
  //ctx.fillText('(1, 1)', vaCanvas.width - 38, 20); // Âè≥‰∏ä
  ctx.fillText('0', 10, vaCanvas.height - 13); // Â∑¶‰∏ã
  ctx.fillText('-1', vaCanvas.width - 23, vaCanvas.height - 13); // Âè≥‰∏ã

  ctx.fillText('Valence', vaCanvas.width / 2 - 20, vaCanvas.height - 10);
  ctx.fillText('Arousal', 5, vaCanvas.height / 2 - 5);
}
document.querySelectorAll('.expression-grid button')[0].click();
function updateKeywordsForEmotion(label) {
  const keywordList = emotionCategories[label] || [];
  keywordsDiv.innerHTML = '';
  keywordList.forEach(kw => {
    const checkbox = document.createElement('label');
    checkbox.innerHTML = `<input type="checkbox" value="${kw}"> ${kw}`;
    keywordsDiv.appendChild(checkbox);
  });
}
vaCanvas.addEventListener('click', (e) => {
  const rect = vaCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left - vaCanvas.width / 2;
  const y = -(e.clientY - rect.top - vaCanvas.height / 2);
  vaCoord = {
    x: parseFloat((x / 100).toFixed(2)),
    y: parseFloat((y / 100).toFixed(2))
  };
  drawCanvas();
  vaText.innerText = `(${vaCoord.x}, ${vaCoord.y})`;
});
drawCanvas();
</script>
</body>
</html>
